CREATE COMPRESSION METHOD jsonb2 HANDLER no_such_handler;
ERROR:  function no_such_handler(internal) does not exist
CREATE COMPRESSION METHOD jsonb HANDLER jsonb_handler;
ERROR:  compression method "jsonb" already exists
CREATE COMPRESSION METHOD jsonb2 HANDLER jsonb_handler;
CREATE TABLE jstest(
	js text COMPRESSED jsonb
);
ERROR:  jsonb compression method is only applicable to json type
CREATE TABLE jstest(
	js text COMPRESSED jsonb2
);
ERROR:  jsonb compression method is only applicable to json type
CREATE TABLE jstest(
	js1 json,
	js2 json COMPRESSED jsonb2,
	js3 json COMPRESSED jsonbc,
	js4 json COMPRESSED jsonbc,
	js5 jsonb
);
INSERT INTO jstest
SELECT js, js, js, js, js
FROM (VALUES
	('{"key1": "val1", "key2": ["val2", 3, 4, 5]}'::json),
	('["val1", 2, {"k1": "v1", "k2": 2}, "", 5, "6"]'),
	('"val"'),
	('12345'),
	(('[' || repeat('"test", ', 10000) || '"test"]')::json)
) AS jsvals(js);
SELECT
	substring(js1::text for 100),
	substring(js2::text for 100),
	substring(js3::text for 100),
	substring(js4::text for 100),
	substring(js5::text for 100)
FROM jstest;
                                              substring                                               |                                              substring                                               |                                              substring                                               |                                              substring                                               |                                              substring                                               
------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------------------------
 {"key1": "val1", "key2": ["val2", 3, 4, 5]}                                                          | {"key1": "val1", "key2": ["val2", 3, 4, 5]}                                                          | {"key1": "val1", "key2": ["val2", 3, 4, 5]}                                                          | {"key1": "val1", "key2": ["val2", 3, 4, 5]}                                                          | {"key1": "val1", "key2": ["val2", 3, 4, 5]}
 ["val1", 2, {"k1": "v1", "k2": 2}, "", 5, "6"]                                                       | ["val1", 2, {"k1": "v1", "k2": 2}, "", 5, "6"]                                                       | ["val1", 2, {"k1": "v1", "k2": 2}, "", 5, "6"]                                                       | ["val1", 2, {"k1": "v1", "k2": 2}, "", 5, "6"]                                                       | ["val1", 2, {"k1": "v1", "k2": 2}, "", 5, "6"]
 "val"                                                                                                | "val"                                                                                                | "val"                                                                                                | "val"                                                                                                | "val"
 12345                                                                                                | 12345                                                                                                | 12345                                                                                                | 12345                                                                                                | 12345
 ["test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "te | ["test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "te | ["test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "te | ["test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "te | ["test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "te
(5 rows)

-- copy json values with different compression
INSERT INTO jstest SELECT js1, js2, js3, js4, js5 FROM jstest LIMIT 5;
INSERT INTO jstest SELECT js2, js3, js4, js5, js1 FROM jstest LIMIT 5;
INSERT INTO jstest SELECT js3, js4, js5, js1, js2 FROM jstest LIMIT 5;
INSERT INTO jstest SELECT js4, js5, js1, js2, js3 FROM jstest LIMIT 5;
INSERT INTO jstest SELECT js5, js1, js2, js3, js4 FROM jstest LIMIT 5;
SELECT
	substring(js1::text for 100),
	substring(js2::text for 100),
	substring(js3::text for 100),
	substring(js4::text for 100),
	substring(js5::text for 100)
FROM jstest;
                                              substring                                               |                                              substring                                               |                                              substring                                               |                                              substring                                               |                                              substring                                               
------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------------------------
 {"key1": "val1", "key2": ["val2", 3, 4, 5]}                                                          | {"key1": "val1", "key2": ["val2", 3, 4, 5]}                                                          | {"key1": "val1", "key2": ["val2", 3, 4, 5]}                                                          | {"key1": "val1", "key2": ["val2", 3, 4, 5]}                                                          | {"key1": "val1", "key2": ["val2", 3, 4, 5]}
 ["val1", 2, {"k1": "v1", "k2": 2}, "", 5, "6"]                                                       | ["val1", 2, {"k1": "v1", "k2": 2}, "", 5, "6"]                                                       | ["val1", 2, {"k1": "v1", "k2": 2}, "", 5, "6"]                                                       | ["val1", 2, {"k1": "v1", "k2": 2}, "", 5, "6"]                                                       | ["val1", 2, {"k1": "v1", "k2": 2}, "", 5, "6"]
 "val"                                                                                                | "val"                                                                                                | "val"                                                                                                | "val"                                                                                                | "val"
 12345                                                                                                | 12345                                                                                                | 12345                                                                                                | 12345                                                                                                | 12345
 ["test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "te | ["test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "te | ["test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "te | ["test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "te | ["test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "te
 {"key1": "val1", "key2": ["val2", 3, 4, 5]}                                                          | {"key1": "val1", "key2": ["val2", 3, 4, 5]}                                                          | {"key1": "val1", "key2": ["val2", 3, 4, 5]}                                                          | {"key1": "val1", "key2": ["val2", 3, 4, 5]}                                                          | {"key1": "val1", "key2": ["val2", 3, 4, 5]}
 ["val1", 2, {"k1": "v1", "k2": 2}, "", 5, "6"]                                                       | ["val1", 2, {"k1": "v1", "k2": 2}, "", 5, "6"]                                                       | ["val1", 2, {"k1": "v1", "k2": 2}, "", 5, "6"]                                                       | ["val1", 2, {"k1": "v1", "k2": 2}, "", 5, "6"]                                                       | ["val1", 2, {"k1": "v1", "k2": 2}, "", 5, "6"]
 "val"                                                                                                | "val"                                                                                                | "val"                                                                                                | "val"                                                                                                | "val"
 12345                                                                                                | 12345                                                                                                | 12345                                                                                                | 12345                                                                                                | 12345
 ["test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "te | ["test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "te | ["test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "te | ["test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "te | ["test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "te
 {"key1": "val1", "key2": ["val2", 3, 4, 5]}                                                          | {"key1": "val1", "key2": ["val2", 3, 4, 5]}                                                          | {"key1": "val1", "key2": ["val2", 3, 4, 5]}                                                          | {"key1": "val1", "key2": ["val2", 3, 4, 5]}                                                          | {"key1": "val1", "key2": ["val2", 3, 4, 5]}
 ["val1", 2, {"k1": "v1", "k2": 2}, "", 5, "6"]                                                       | ["val1", 2, {"k1": "v1", "k2": 2}, "", 5, "6"]                                                       | ["val1", 2, {"k1": "v1", "k2": 2}, "", 5, "6"]                                                       | ["val1", 2, {"k1": "v1", "k2": 2}, "", 5, "6"]                                                       | ["val1", 2, {"k1": "v1", "k2": 2}, "", 5, "6"]
 "val"                                                                                                | "val"                                                                                                | "val"                                                                                                | "val"                                                                                                | "val"
 12345                                                                                                | 12345                                                                                                | 12345                                                                                                | 12345                                                                                                | 12345
 ["test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "te | ["test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "te | ["test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "te | ["test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "te | ["test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "te
 {"key1": "val1", "key2": ["val2", 3, 4, 5]}                                                          | {"key1": "val1", "key2": ["val2", 3, 4, 5]}                                                          | {"key1": "val1", "key2": ["val2", 3, 4, 5]}                                                          | {"key1": "val1", "key2": ["val2", 3, 4, 5]}                                                          | {"key1": "val1", "key2": ["val2", 3, 4, 5]}
 ["val1", 2, {"k1": "v1", "k2": 2}, "", 5, "6"]                                                       | ["val1", 2, {"k1": "v1", "k2": 2}, "", 5, "6"]                                                       | ["val1", 2, {"k1": "v1", "k2": 2}, "", 5, "6"]                                                       | ["val1", 2, {"k1": "v1", "k2": 2}, "", 5, "6"]                                                       | ["val1", 2, {"k1": "v1", "k2": 2}, "", 5, "6"]
 "val"                                                                                                | "val"                                                                                                | "val"                                                                                                | "val"                                                                                                | "val"
 12345                                                                                                | 12345                                                                                                | 12345                                                                                                | 12345                                                                                                | 12345
 ["test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "te | ["test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "te | ["test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "te | ["test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "te | ["test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "te
 {"key1": "val1", "key2": ["val2", 3, 4, 5]}                                                          | {"key1": "val1", "key2": ["val2", 3, 4, 5]}                                                          | {"key1": "val1", "key2": ["val2", 3, 4, 5]}                                                          | {"key1": "val1", "key2": ["val2", 3, 4, 5]}                                                          | {"key1": "val1", "key2": ["val2", 3, 4, 5]}
 ["val1", 2, {"k1": "v1", "k2": 2}, "", 5, "6"]                                                       | ["val1", 2, {"k1": "v1", "k2": 2}, "", 5, "6"]                                                       | ["val1", 2, {"k1": "v1", "k2": 2}, "", 5, "6"]                                                       | ["val1", 2, {"k1": "v1", "k2": 2}, "", 5, "6"]                                                       | ["val1", 2, {"k1": "v1", "k2": 2}, "", 5, "6"]
 "val"                                                                                                | "val"                                                                                                | "val"                                                                                                | "val"                                                                                                | "val"
 12345                                                                                                | 12345                                                                                                | 12345                                                                                                | 12345                                                                                                | 12345
 ["test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "te | ["test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "te | ["test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "te | ["test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "te | ["test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "te
 {"key1": "val1", "key2": ["val2", 3, 4, 5]}                                                          | {"key1": "val1", "key2": ["val2", 3, 4, 5]}                                                          | {"key1": "val1", "key2": ["val2", 3, 4, 5]}                                                          | {"key1": "val1", "key2": ["val2", 3, 4, 5]}                                                          | {"key1": "val1", "key2": ["val2", 3, 4, 5]}
 ["val1", 2, {"k1": "v1", "k2": 2}, "", 5, "6"]                                                       | ["val1", 2, {"k1": "v1", "k2": 2}, "", 5, "6"]                                                       | ["val1", 2, {"k1": "v1", "k2": 2}, "", 5, "6"]                                                       | ["val1", 2, {"k1": "v1", "k2": 2}, "", 5, "6"]                                                       | ["val1", 2, {"k1": "v1", "k2": 2}, "", 5, "6"]
 "val"                                                                                                | "val"                                                                                                | "val"                                                                                                | "val"                                                                                                | "val"
 12345                                                                                                | 12345                                                                                                | 12345                                                                                                | 12345                                                                                                | 12345
 ["test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "te | ["test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "te | ["test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "te | ["test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "te | ["test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "test", "te
(30 rows)

-- check column sizes
SELECT
	pg_column_size(js1),
	pg_column_size(js2),
	pg_column_size(js3),
	pg_column_size(js4),
	pg_column_size(js5)
FROM jstest;
 pg_column_size | pg_column_size | pg_column_size | pg_column_size | pg_column_size 
----------------+----------------+----------------+----------------+----------------
             44 |             94 |             39 |             39 |             81
             47 |             99 |             40 |             40 |             86
              6 |             25 |             23 |             23 |             12
              6 |             32 |             22 |             22 |             19
            937 |          80026 |          51697 |          51697 |           1815
             44 |             94 |             39 |             39 |             81
             47 |             99 |             40 |             40 |             86
              6 |             25 |             23 |             23 |             12
              6 |             32 |             22 |             22 |             19
            937 |          80026 |          51697 |          51697 |           1815
             44 |             94 |             39 |             39 |             81
             47 |             99 |             40 |             40 |             86
              6 |             25 |             23 |             23 |             12
              6 |             32 |             22 |             22 |             19
            937 |          80026 |          51697 |          51697 |           1815
             44 |             94 |             39 |             39 |             81
             47 |             99 |             40 |             40 |             86
              6 |             25 |             23 |             23 |             12
              6 |             32 |             22 |             22 |             19
            937 |          80026 |          51697 |          51697 |           1815
             44 |             94 |             39 |             39 |             81
             47 |             99 |             40 |             40 |             86
              6 |             25 |             23 |             23 |             12
              6 |             32 |             22 |             22 |             19
            937 |          80026 |          51697 |          51697 |           1815
             44 |             94 |             39 |             39 |             81
             47 |             99 |             40 |             40 |             86
              6 |             25 |             23 |             23 |             12
              6 |             32 |             22 |             22 |             19
            937 |          80026 |          51697 |          51697 |           1815
(30 rows)

CREATE FUNCTION jsonbc_dict_contents() RETURNS TABLE (dict name, id integer, name text)
LANGUAGE sql AS '
SELECT
	c.relname dict, d.id, d.name
FROM
	pg_jsonbc_dict d LEFT JOIN pg_class c ON d.dict = c.oid
ORDER BY 1, 2, 3';
CREATE FUNCTION jsonbc_dict_deps() RETURNS TABLE (relname name, attnum integer, cmname name)
LANGUAGE sql AS '
SELECT
	d.objid::regclass::name relname, d.objsubid attnum, c.cmname
FROM
	pg_depend d JOIN pg_compression c ON d.refobjid = c.oid
WHERE
	classid = ''pg_class''::regclass AND
	refclassid = ''pg_compression''::regclass
ORDER BY 1, 2';
SELECT * FROM jsonbc_dict_contents();
            dict            | id | name 
----------------------------+----+------
 jstest_js3_jsonbc_dict_seq |  1 | key1
 jstest_js3_jsonbc_dict_seq |  2 | key2
 jstest_js3_jsonbc_dict_seq |  3 | k1
 jstest_js3_jsonbc_dict_seq |  4 | k2
 jstest_js4_jsonbc_dict_seq |  1 | key1
 jstest_js4_jsonbc_dict_seq |  2 | key2
 jstest_js4_jsonbc_dict_seq |  3 | k1
 jstest_js4_jsonbc_dict_seq |  4 | k2
(8 rows)

-- alter column compression methods
SELECT relname, relkind FROM pg_class WHERE relname LIKE 'jstest%';
          relname           | relkind 
----------------------------+---------
 jstest                     | r
 jstest_js3_jsonbc_dict_seq | S
 jstest_js4_jsonbc_dict_seq | S
(3 rows)

ALTER TABLE jstest ALTER js1 SET COMPRESSED jsonbc;
SELECT relname, relkind FROM pg_class WHERE relname LIKE 'jstest%';
          relname           | relkind 
----------------------------+---------
 jstest                     | r
 jstest_js1_jsonbc_dict_seq | S
 jstest_js3_jsonbc_dict_seq | S
 jstest_js4_jsonbc_dict_seq | S
(4 rows)

SELECT * FROM jsonbc_dict_contents();
            dict            | id | name 
----------------------------+----+------
 jstest_js1_jsonbc_dict_seq |  1 | key1
 jstest_js1_jsonbc_dict_seq |  2 | key2
 jstest_js1_jsonbc_dict_seq |  3 | k1
 jstest_js1_jsonbc_dict_seq |  4 | k2
 jstest_js3_jsonbc_dict_seq |  1 | key1
 jstest_js3_jsonbc_dict_seq |  2 | key2
 jstest_js3_jsonbc_dict_seq |  3 | k1
 jstest_js3_jsonbc_dict_seq |  4 | k2
 jstest_js4_jsonbc_dict_seq |  1 | key1
 jstest_js4_jsonbc_dict_seq |  2 | key2
 jstest_js4_jsonbc_dict_seq |  3 | k1
 jstest_js4_jsonbc_dict_seq |  4 | k2
(12 rows)

SELECT * FROM jsonbc_dict_deps() WHERE relname = 'jstest';
 relname | attnum |   cmname   
---------+--------+------------
 jstest  |      1 | jsonbc
 jstest  |      2 | jsonb2
 jstest  |      3 | jsonbc
 jstest  |      4 | jsonbc
 jstest  |      5 | jsonb_null
(5 rows)

ALTER TABLE jstest ALTER js2 SET NOT COMPRESSED;
SELECT relname, relkind FROM pg_class WHERE relname LIKE 'jstest%';
          relname           | relkind 
----------------------------+---------
 jstest                     | r
 jstest_js1_jsonbc_dict_seq | S
 jstest_js3_jsonbc_dict_seq | S
 jstest_js4_jsonbc_dict_seq | S
(4 rows)

SELECT * FROM jsonbc_dict_contents();
            dict            | id | name 
----------------------------+----+------
 jstest_js1_jsonbc_dict_seq |  1 | key1
 jstest_js1_jsonbc_dict_seq |  2 | key2
 jstest_js1_jsonbc_dict_seq |  3 | k1
 jstest_js1_jsonbc_dict_seq |  4 | k2
 jstest_js3_jsonbc_dict_seq |  1 | key1
 jstest_js3_jsonbc_dict_seq |  2 | key2
 jstest_js3_jsonbc_dict_seq |  3 | k1
 jstest_js3_jsonbc_dict_seq |  4 | k2
 jstest_js4_jsonbc_dict_seq |  1 | key1
 jstest_js4_jsonbc_dict_seq |  2 | key2
 jstest_js4_jsonbc_dict_seq |  3 | k1
 jstest_js4_jsonbc_dict_seq |  4 | k2
(12 rows)

SELECT * FROM jsonbc_dict_deps() WHERE relname = 'jstest';
 relname | attnum |   cmname   
---------+--------+------------
 jstest  |      1 | jsonbc
 jstest  |      2 | json_null
 jstest  |      3 | jsonbc
 jstest  |      4 | jsonbc
 jstest  |      5 | jsonb_null
(5 rows)

ALTER TABLE jstest ALTER js3 SET NOT COMPRESSED;
SELECT relname, relkind FROM pg_class WHERE relname LIKE 'jstest%';
          relname           | relkind 
----------------------------+---------
 jstest                     | r
 jstest_js1_jsonbc_dict_seq | S
 jstest_js4_jsonbc_dict_seq | S
(3 rows)

SELECT * FROM jsonbc_dict_contents();
            dict            | id | name 
----------------------------+----+------
 jstest_js1_jsonbc_dict_seq |  1 | key1
 jstest_js1_jsonbc_dict_seq |  2 | key2
 jstest_js1_jsonbc_dict_seq |  3 | k1
 jstest_js1_jsonbc_dict_seq |  4 | k2
 jstest_js4_jsonbc_dict_seq |  1 | key1
 jstest_js4_jsonbc_dict_seq |  2 | key2
 jstest_js4_jsonbc_dict_seq |  3 | k1
 jstest_js4_jsonbc_dict_seq |  4 | k2
(8 rows)

SELECT * FROM jsonbc_dict_deps() WHERE relname = 'jstest';
 relname | attnum |   cmname   
---------+--------+------------
 jstest  |      1 | jsonbc
 jstest  |      2 | json_null
 jstest  |      3 | json_null
 jstest  |      4 | jsonbc
 jstest  |      5 | jsonb_null
(5 rows)

ALTER TABLE jstest ALTER js3 SET COMPRESSED jsonb2;
SELECT relname, relkind FROM pg_class WHERE relname LIKE 'jstest%';
          relname           | relkind 
----------------------------+---------
 jstest                     | r
 jstest_js1_jsonbc_dict_seq | S
 jstest_js4_jsonbc_dict_seq | S
(3 rows)

SELECT * FROM jsonbc_dict_contents();
            dict            | id | name 
----------------------------+----+------
 jstest_js1_jsonbc_dict_seq |  1 | key1
 jstest_js1_jsonbc_dict_seq |  2 | key2
 jstest_js1_jsonbc_dict_seq |  3 | k1
 jstest_js1_jsonbc_dict_seq |  4 | k2
 jstest_js4_jsonbc_dict_seq |  1 | key1
 jstest_js4_jsonbc_dict_seq |  2 | key2
 jstest_js4_jsonbc_dict_seq |  3 | k1
 jstest_js4_jsonbc_dict_seq |  4 | k2
(8 rows)

SELECT * FROM jsonbc_dict_deps() WHERE relname = 'jstest';
 relname | attnum |   cmname   
---------+--------+------------
 jstest  |      1 | jsonbc
 jstest  |      2 | json_null
 jstest  |      3 | jsonb2
 jstest  |      4 | jsonbc
 jstest  |      5 | jsonb_null
(5 rows)

ALTER TABLE jstest ADD js6 json COMPRESSED jsonbc;
UPDATE jstest SET js6 = js1;
SELECT relname, relkind FROM pg_class WHERE relname LIKE 'jstest%';
          relname           | relkind 
----------------------------+---------
 jstest                     | r
 jstest_js1_jsonbc_dict_seq | S
 jstest_js4_jsonbc_dict_seq | S
 jstest_js6_jsonbc_dict_seq | S
(4 rows)

SELECT * FROM jsonbc_dict_contents();
            dict            | id | name 
----------------------------+----+------
 jstest_js1_jsonbc_dict_seq |  1 | key1
 jstest_js1_jsonbc_dict_seq |  2 | key2
 jstest_js1_jsonbc_dict_seq |  3 | k1
 jstest_js1_jsonbc_dict_seq |  4 | k2
 jstest_js4_jsonbc_dict_seq |  1 | key1
 jstest_js4_jsonbc_dict_seq |  2 | key2
 jstest_js4_jsonbc_dict_seq |  3 | k1
 jstest_js4_jsonbc_dict_seq |  4 | k2
 jstest_js6_jsonbc_dict_seq |  1 | key1
 jstest_js6_jsonbc_dict_seq |  2 | key2
 jstest_js6_jsonbc_dict_seq |  3 | k1
 jstest_js6_jsonbc_dict_seq |  4 | k2
(12 rows)

SELECT * FROM jsonbc_dict_deps() WHERE relname = 'jstest';
 relname | attnum |   cmname   
---------+--------+------------
 jstest  |      1 | jsonbc
 jstest  |      2 | json_null
 jstest  |      3 | jsonb2
 jstest  |      4 | jsonbc
 jstest  |      5 | jsonb_null
 jstest  |      6 | jsonbc
(6 rows)

-- try to use existing jsonbc dictionary
DO
$$
DECLARE
	dict_id oid;
BEGIN
	SELECT substring(attcmoptions[1] from 9)
	INTO STRICT dict_id
	FROM pg_attribute
	WHERE attrelid = (SELECT oid FROM pg_class WHERE relname = 'jstest')
	AND attname = 'js6';

	EXECUTE 'ALTER TABLE jstest ADD js7 json COMPRESSED jsonbc WITH (dict_id ''' || dict_id || ''')';
END
$$;
SELECT relname, relkind FROM pg_class WHERE relname LIKE 'jstest%';
          relname           | relkind 
----------------------------+---------
 jstest                     | r
 jstest_js1_jsonbc_dict_seq | S
 jstest_js4_jsonbc_dict_seq | S
 jstest_js6_jsonbc_dict_seq | S
(4 rows)

SELECT * FROM jsonbc_dict_contents();
            dict            | id | name 
----------------------------+----+------
 jstest_js1_jsonbc_dict_seq |  1 | key1
 jstest_js1_jsonbc_dict_seq |  2 | key2
 jstest_js1_jsonbc_dict_seq |  3 | k1
 jstest_js1_jsonbc_dict_seq |  4 | k2
 jstest_js4_jsonbc_dict_seq |  1 | key1
 jstest_js4_jsonbc_dict_seq |  2 | key2
 jstest_js4_jsonbc_dict_seq |  3 | k1
 jstest_js4_jsonbc_dict_seq |  4 | k2
 jstest_js6_jsonbc_dict_seq |  1 | key1
 jstest_js6_jsonbc_dict_seq |  2 | key2
 jstest_js6_jsonbc_dict_seq |  3 | k1
 jstest_js6_jsonbc_dict_seq |  4 | k2
(12 rows)

SELECT * FROM jsonbc_dict_deps() WHERE relname = 'jstest';
 relname | attnum |   cmname   
---------+--------+------------
 jstest  |      1 | jsonbc
 jstest  |      2 | json_null
 jstest  |      3 | jsonb2
 jstest  |      4 | jsonbc
 jstest  |      5 | jsonb_null
 jstest  |      6 | jsonbc
 jstest  |      7 | jsonbc
(7 rows)

-- should fail
ALTER TABLE jstest DROP js6;
ERROR:  cannot drop table jstest column js6 because other objects depend on it
DETAIL:  table jstest column js7 depends on sequence jstest_js6_jsonbc_dict_seq
HINT:  Use DROP ... CASCADE to drop the dependent objects too.
SELECT relname, relkind FROM pg_class WHERE relname LIKE 'jstest%';
          relname           | relkind 
----------------------------+---------
 jstest                     | r
 jstest_js1_jsonbc_dict_seq | S
 jstest_js4_jsonbc_dict_seq | S
 jstest_js6_jsonbc_dict_seq | S
(4 rows)

SELECT * FROM jsonbc_dict_contents();
            dict            | id | name 
----------------------------+----+------
 jstest_js1_jsonbc_dict_seq |  1 | key1
 jstest_js1_jsonbc_dict_seq |  2 | key2
 jstest_js1_jsonbc_dict_seq |  3 | k1
 jstest_js1_jsonbc_dict_seq |  4 | k2
 jstest_js4_jsonbc_dict_seq |  1 | key1
 jstest_js4_jsonbc_dict_seq |  2 | key2
 jstest_js4_jsonbc_dict_seq |  3 | k1
 jstest_js4_jsonbc_dict_seq |  4 | k2
 jstest_js6_jsonbc_dict_seq |  1 | key1
 jstest_js6_jsonbc_dict_seq |  2 | key2
 jstest_js6_jsonbc_dict_seq |  3 | k1
 jstest_js6_jsonbc_dict_seq |  4 | k2
(12 rows)

SELECT * FROM jsonbc_dict_deps() WHERE relname = 'jstest';
 relname | attnum |   cmname   
---------+--------+------------
 jstest  |      1 | jsonbc
 jstest  |      2 | json_null
 jstest  |      3 | jsonb2
 jstest  |      4 | jsonbc
 jstest  |      5 | jsonb_null
 jstest  |      6 | jsonbc
 jstest  |      7 | jsonbc
(7 rows)

ALTER TABLE jstest ALTER js6 SET NOT COMPRESSED;
ALTER TABLE jstest DROP js6;
SELECT relname, relkind FROM pg_class WHERE relname LIKE 'jstest%';
          relname           | relkind 
----------------------------+---------
 jstest                     | r
 jstest_js1_jsonbc_dict_seq | S
 jstest_js4_jsonbc_dict_seq | S
 jstest_js6_jsonbc_dict_seq | S
(4 rows)

SELECT * FROM jsonbc_dict_contents();
            dict            | id | name 
----------------------------+----+------
 jstest_js1_jsonbc_dict_seq |  1 | key1
 jstest_js1_jsonbc_dict_seq |  2 | key2
 jstest_js1_jsonbc_dict_seq |  3 | k1
 jstest_js1_jsonbc_dict_seq |  4 | k2
 jstest_js4_jsonbc_dict_seq |  1 | key1
 jstest_js4_jsonbc_dict_seq |  2 | key2
 jstest_js4_jsonbc_dict_seq |  3 | k1
 jstest_js4_jsonbc_dict_seq |  4 | k2
 jstest_js6_jsonbc_dict_seq |  1 | key1
 jstest_js6_jsonbc_dict_seq |  2 | key2
 jstest_js6_jsonbc_dict_seq |  3 | k1
 jstest_js6_jsonbc_dict_seq |  4 | k2
(12 rows)

SELECT * FROM jsonbc_dict_deps() WHERE relname = 'jstest';
 relname | attnum |   cmname   
---------+--------+------------
 jstest  |      1 | jsonbc
 jstest  |      2 | json_null
 jstest  |      3 | jsonb2
 jstest  |      4 | jsonbc
 jstest  |      5 | jsonb_null
 jstest  |      7 | jsonbc
(6 rows)

ALTER TABLE jstest ALTER js7 SET COMPRESSED jsonb2;
SELECT relname, relkind FROM pg_class WHERE relname LIKE 'jstest%';
          relname           | relkind 
----------------------------+---------
 jstest                     | r
 jstest_js1_jsonbc_dict_seq | S
 jstest_js4_jsonbc_dict_seq | S
 jstest_js6_jsonbc_dict_seq | S
(4 rows)

SELECT * FROM jsonbc_dict_contents();
            dict            | id | name 
----------------------------+----+------
 jstest_js1_jsonbc_dict_seq |  1 | key1
 jstest_js1_jsonbc_dict_seq |  2 | key2
 jstest_js1_jsonbc_dict_seq |  3 | k1
 jstest_js1_jsonbc_dict_seq |  4 | k2
 jstest_js4_jsonbc_dict_seq |  1 | key1
 jstest_js4_jsonbc_dict_seq |  2 | key2
 jstest_js4_jsonbc_dict_seq |  3 | k1
 jstest_js4_jsonbc_dict_seq |  4 | k2
 jstest_js6_jsonbc_dict_seq |  1 | key1
 jstest_js6_jsonbc_dict_seq |  2 | key2
 jstest_js6_jsonbc_dict_seq |  3 | k1
 jstest_js6_jsonbc_dict_seq |  4 | k2
(12 rows)

SELECT * FROM jsonbc_dict_deps() WHERE relname = 'jstest';
 relname | attnum |   cmname   
---------+--------+------------
 jstest  |      1 | jsonbc
 jstest  |      2 | json_null
 jstest  |      3 | jsonb2
 jstest  |      4 | jsonbc
 jstest  |      5 | jsonb_null
 jstest  |      7 | jsonb2
(6 rows)

-- manually drop remaining dictionary
DROP SEQUENCE jstest_js6_jsonbc_dict_seq;
SELECT relname, relkind FROM pg_class WHERE relname LIKE 'jstest%';
          relname           | relkind 
----------------------------+---------
 jstest                     | r
 jstest_js1_jsonbc_dict_seq | S
 jstest_js4_jsonbc_dict_seq | S
(3 rows)

SELECT * FROM jsonbc_dict_contents();
            dict            | id | name 
----------------------------+----+------
 jstest_js1_jsonbc_dict_seq |  1 | key1
 jstest_js1_jsonbc_dict_seq |  2 | key2
 jstest_js1_jsonbc_dict_seq |  3 | k1
 jstest_js1_jsonbc_dict_seq |  4 | k2
 jstest_js4_jsonbc_dict_seq |  1 | key1
 jstest_js4_jsonbc_dict_seq |  2 | key2
 jstest_js4_jsonbc_dict_seq |  3 | k1
 jstest_js4_jsonbc_dict_seq |  4 | k2
(8 rows)

SELECT * FROM jsonbc_dict_deps() WHERE relname = 'jstest';
 relname | attnum |   cmname   
---------+--------+------------
 jstest  |      1 | jsonbc
 jstest  |      2 | json_null
 jstest  |      3 | jsonb2
 jstest  |      4 | jsonbc
 jstest  |      5 | jsonb_null
 jstest  |      7 | jsonb2
(6 rows)

-- Try to drop compression method: fail because of dependent objects
DROP COMPRESSION METHOD jsonb2;
ERROR:  cannot drop compression method jsonb2 because other objects depend on it
DETAIL:  table jstest column js3 depends on compression method jsonb2
table jstest column js7 depends on compression method jsonb2
HINT:  Use DROP ... CASCADE to drop the dependent objects too.
-- Drop compression method cascade
DROP COMPRESSION METHOD jsonb2 CASCADE;
NOTICE:  drop cascades to 2 other objects
DETAIL:  drop cascades to table jstest column js3
drop cascades to table jstest column js7
SELECT * FROM jstest LIMIT 0;
 js1 | js2 | js4 | js5 
-----+-----+-----+-----
(0 rows)

DROP TABLE jstest;
SELECT relname, relkind FROM pg_class WHERE relname LIKE 'jstest%';
 relname | relkind 
---------+---------
(0 rows)

SELECT * FROM jsonbc_dict_contents();
 dict | id | name 
------+----+------
(0 rows)

SELECT * FROM jsonbc_dict_deps() WHERE relname = 'jstest';
 relname | attnum | cmname 
---------+--------+--------
(0 rows)

-- Test ALTER TYPE SET COMPRESSED
ALTER TYPE json SET COMPRESSED jsonb;
CREATE TABLE jstest (js json);
SELECT attcompression FROM pg_attribute WHERE attrelid = 'jstest'::regclass AND attnum = 1;
 attcompression 
----------------
           3403
(1 row)

INSERT INTO jstest VALUES ('[ 123,  "abc", { "k" : "v" }  ]');
SELECT * FROM jstest;
            js            
--------------------------
 [123, "abc", {"k": "v"}]
(1 row)

DROP TABLE jstest;
ALTER TYPE json SET NOT COMPRESSED;
CREATE TABLE jstest (js json);
SELECT attcompression FROM pg_attribute WHERE attrelid = 'jstest'::regclass AND attnum = 1;
 attcompression 
----------------
           3451
(1 row)

INSERT INTO jstest VALUES ('[ 123,  "abc", { "k" : "v" }  ]');
SELECT * FROM jstest;
               js                
---------------------------------
 [ 123,  "abc", { "k" : "v" }  ]
(1 row)

DROP TABLE jstest;
-- Test compressable type creation
CREATE TYPE json2;
CREATE TEMP TABLE json2_procs AS
SELECT * FROM pg_proc p WHERE proname IN ('json_in', 'json_out', 'json_null_cm_handler');
UPDATE json2_procs
SET proname = replace(proname, 'json_', 'json2_');
UPDATE json2_procs
SET prorettype = (SELECT oid FROM pg_type WHERE typname = 'json2')
WHERE proname = 'json2_in';
UPDATE json2_procs
SET proargtypes = (SELECT oid::text::oidvector FROM pg_type WHERE typname = 'json2')
WHERE proname = 'json2_out';
INSERT INTO pg_proc
SELECT * FROM json2_procs;
CREATE COMPRESSION METHOD json2_null HANDLER json2_null_cm_handler;
CREATE TYPE json2 (
	INPUT  = json2_in,
	OUTPUT = json2_out,
	NULLCM = json2_null
);
CREATE TEMP TABLE tjson2(js json2);
INSERT INTO tjson2 VALUES ('abc');
ERROR:  invalid input syntax for type json
LINE 1: INSERT INTO tjson2 VALUES ('abc');
                                   ^
DETAIL:  Token "abc" is invalid.
CONTEXT:  JSON data, line 1: abc
INSERT INTO tjson2 VALUES ('["abc", {"key": 123}, null]');
SELECT * FROM tjson2;
             js              
-----------------------------
 ["abc", {"key": 123}, null]
(1 row)

DROP FUNCTION json2_null_cm_handler(internal);
ERROR:  cannot drop function json2_null_cm_handler(internal) because other objects depend on it
DETAIL:  compression method json2_null depends on function json2_null_cm_handler(internal)
type json2 depends on compression method json2_null
table tjson2 column js depends on compression method json2_null
HINT:  Use DROP ... CASCADE to drop the dependent objects too.
DROP FUNCTION json2_in(cstring);
ERROR:  cannot drop function json2_in(cstring) because other objects depend on it
DETAIL:  type json2 depends on function json2_in(cstring)
table tjson2 column js depends on type json2
HINT:  Use DROP ... CASCADE to drop the dependent objects too.
DROP FUNCTION json2_out(json2);
ERROR:  cannot drop function json2_out(json2) because other objects depend on it
DETAIL:  type json2 depends on function json2_out(json2)
table tjson2 column js depends on type json2
HINT:  Use DROP ... CASCADE to drop the dependent objects too.
DROP FUNCTION json2_out(json2) CASCADE;
NOTICE:  drop cascades to 2 other objects
DETAIL:  drop cascades to type json2
drop cascades to table tjson2 column js
DROP FUNCTION json2_in(cstring);
DROP FUNCTION json2_null_cm_handler(internal);
ERROR:  cannot drop function json2_null_cm_handler(internal) because other objects depend on it
DETAIL:  compression method json2_null depends on function json2_null_cm_handler(internal)
HINT:  Use DROP ... CASCADE to drop the dependent objects too.
DROP FUNCTION json2_null_cm_handler(internal) CASCADE;
NOTICE:  drop cascades to compression method json2_null
DROP TABLE tjson2;
-- Test compression methods on domains
CREATE DOMAIN json_not_null AS json NOT NULL;
CREATE TEMP TABLE json_domain_test1(js json_not_null);
SELECT attcompression FROM pg_attribute WHERE attrelid = 'json_domain_test1'::regclass AND attnum = 1;
 attcompression 
----------------
           3451
(1 row)

DROP TABLE json_domain_test1;
CREATE TEMP TABLE json_domain_test2(js json_not_null compressed jsonb);
SELECT attcompression FROM pg_attribute WHERE attrelid = 'json_domain_test2'::regclass AND attnum = 1;
 attcompression 
----------------
           3403
(1 row)

DROP TABLE json_domain_test2;
-- Test compression inheritance
create temp table json_parent1(js json);
create temp table json_parent2(js json compressed jsonb);
create temp table json_parent3(js json compressed jsonb);
create temp table json_child1(js json) inherits (json_parent1);
NOTICE:  merging column "js" with inherited definition
create temp table json_child2(js json) inherits (json_parent2);
NOTICE:  merging column "js" with inherited definition
create temp table json_child3(js json compressed jsonb) inherits (json_parent1);
NOTICE:  merging column "js" with inherited definition
ERROR:  column "js" has a compression method conflict
DETAIL:  json_null versus jsonb
create temp table json_child4(js json compressed jsonb) inherits (json_parent2);
NOTICE:  merging column "js" with inherited definition
create temp table json_child5(js json) inherits (json_parent1, json_parent2);
NOTICE:  merging multiple inherited definitions of column "js"
ERROR:  column "js" has a compression method conflict
DETAIL:  json_null versus jsonb
create temp table json_child6(js json) inherits (json_parent2, json_parent3);
NOTICE:  merging multiple inherited definitions of column "js"
NOTICE:  merging column "js" with inherited definition
create temp table json_child7(js json compressed jsonb) inherits (json_parent2, json_parent3);
NOTICE:  merging multiple inherited definitions of column "js"
NOTICE:  merging column "js" with inherited definition
SELECT a.attrelid::regclass, a.attnum, c.cmname
FROM pg_attribute a JOIN pg_compression c ON a.attcompression = c.oid
WHERE a.attrelid::regclass::text LIKE 'json_child%' AND a.attnum = 1;
  attrelid   | attnum |  cmname   
-------------+--------+-----------
 json_child1 |      1 | json_null
 json_child2 |      1 | jsonb
 json_child4 |      1 | jsonb
 json_child6 |      1 | jsonb
 json_child7 |      1 | jsonb
(5 rows)

drop table json_parent1 cascade;
NOTICE:  drop cascades to table json_child1
drop table json_parent2 cascade;
NOTICE:  drop cascades to 4 other objects
DETAIL:  drop cascades to table json_child2
drop cascades to table json_child4
drop cascades to table json_child6
drop cascades to table json_child7
drop table json_parent3 cascade;
